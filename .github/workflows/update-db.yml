name: Update DB and Rebuild GZ

on:
  workflow_dispatch:
    inputs:
      reason:
        required: false
        type: string
  push:
    paths:
      - 'patches/*.sql'        # també s'executa si pujes un .sql directament

jobs:
  apply-patches:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          lfs: false

      - name: Install sqlite3 and gzip
        run: |
          sudo apt-get update
          sudo apt-get install -y sqlite3 gzip

      - name: Ensure DB exists
        run: |
          if [ ! -f public/CollecTF.db ]; then
            # si només tens .gz al repo, descomprimeix-lo una vegada
            if [ -f public/CollecTF.db.gz ]; then
              gunzip -c public/CollecTF.db.gz > public/CollecTF.db
            else
              echo "ERROR: no DB found (public/CollecTF.db or .gz)"; exit 1
            fi
          fi

      - name: Apply SQL patches
        run: |
          shopt -s nullglob
          for f in patches/*.sql; do
            echo "Applying $f"
            sqlite3 public/CollecTF.db < "$f"
            rm "$f"
          done

      - name: Rebuild GZ
        run: |
          gzip -c public/CollecTF.db > public/CollecTF.db.gz

      - name: Commit changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add public/CollecTF.db public/CollecTF.db.gz || true
          git add -A patches || true
          git commit -m "build(db): apply patches and rebuild gz" || echo "nothing to commit"
          git push
